<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layouts/layout}">
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<head>
<style>
.btn-secondary {
	margin-left: 20px;
}

span {
	color: #494949;
	font-weight: bold;
}

#pageing {
	border: 1px solid #e6e6e6;
	line-height: 30px;
	background-color: #fff;
	color: #999999;
}

.input {
	height: 23px;
	margin-left: 10px;
	margin-right: 10px;
	display: inline-block;
	padding: 0 10px;
	vertical-align: middle;
	border: 1px solid #dddddd;
	width: 20%;
	color: rgb(94, 94, 94);
	border-radius: 5px;
	text-align: center;
}

#leftinput, #rightinput {
	margin-right: 18px;
}

#leftinput1 {
	background-color: #f1f1f1;
}

#startCNDATE {
	margin-right: 10px;
}

#endCNDATE {
	margin-left: 5px;
}

.dataTable-input {
	height: 40px;
}

.nameing {
	float: right;
	font-size: medium;
	font-weight: normal;
}

#modal {
	display: none;
}

.title {
	text-align: center;
	margin-bottom: 10px;
	margin-top: -10px;
}
</style>
</head>
<body class="sb-nav-fixed">
	<th:block layout:fragment="main">
		<div class="container-fluid px-4">
			<h2 class="mt-4">
				출하 관리
				<div class="nameing">
					<a href="/" style="text-decoration-line: none; color: black">홈</a>>영업관리>출하관리
				</div>
			</h2>

			<!-- 메인화면 버튼 -->
			<div class="card-header" id="btn">
				<div style="display: flex; justify-content: flex-end;">
					<button class="btn btn-secondary">진행상태변경</button>
					<button class="btn btn-secondary" id="rightinput">미출고건조회</button>
					<button id="searchBtn" class="btn btn-secondary">조회</button>
					<button id="insertBtn" class="btn btn-secondary">등록</button>
					<button id="deleteBtn" class="btn btn-secondary">삭제</button>
				</div>
			</div>

			<!-- 메인화면 검색 -->
			<div class="card mb-4" id="pageing">
				<div class="card-body">
					<span> 납기일자<input type="date" name="startCnperiod" id="startCnperiod" class="input" />~ 
								<input type="date" name="endCnperiod" id="endCnperiod" class="input" /><br> 
						   출고일자<input type="date" name="startShdate" id="startShdate" class="input" />~ 
						   		<input type="date" name="endShdate" id="endShdate" class="input" /><br> 
						   제품코드<input type="text" id="leftinput" class="input" placeholder="제품 검색" readonly="readonly">
					   		 	<input type="text" id="leftinput1" class="input" placeholder="제품 코드" readonly="readonly"><br>
					</span>
				</div>
			</div>
		</div>

		<!-- 메인화면 그리드 -->
		<div class="container-fluid px-4">
			<div class="card mb-4">
				<div class="card-header">
					<i class="fas fa-table me-1"></i> 출하관리
				</div>
				<div id="grid"></div>
			</div>
		</div>

		<!-- 모달  -->
		<div id="modal">

			<!-- 미출고건조회 모달 -->
			<div id="shippingModal" style="padding: 20px;" title="미출고조회">
				<div class="container">
					<div class="title">
						<span> 납기일자<input type="date" name="startCNDATE" id="startCNDATE" class="input" />~ 
									<input type="date" name="endCNDATE" id="endCNDATE" class="input" />
							<button class="btn btn-secondary">조회</button> <br>
					</div>
				</div>
				<div class="container-fluid px-4">
					<div class="card mb-4">
						<div class="card-header" style="text-align: center;">
							<i class="fas fa-table me-1"></i> 미출고조회
						</div>
						<div id="gridcomp"></div>
					</div>
				</div>
			</div>

			<!-- 제품모달 -->
			<div id="prodNameModal" style="padding: 20px;" title="제품정보조회">
				<div class="container">
					<div class="title">
						제품명<input type="text" id="giinput" class="input" placeholder="제품명"> 
							<button id="gisearchBtn" class="btn btn-secondary">조회</button><br>
					</div>
				</div>
				
				<!-- 제품모달 그리드 -->
				<div class="container-fluid px-4">
					<div class="card mb-4">
						<div class="card-header" style="text-align: center;">
							<i class="fas fa-table me-1"></i> 제품정보
						</div>
						<div id="gridpro"></div>
					</div>
				</div>
			</div>
		</div>


		<script>

			$(function() {
				
				/* 출고관리 출고조회 */
				$('#searchBtn').on('click', function() {
				var startCp = $('#startCnperiod').val()
				var endCp = $('#endCnperiod').val()
				var startSd = $('#startShdate').val()
				var endSd = $('#endShdate').val()
			    var gsCode = $('#leftinput1').val() 
						 if($('#startCnperiod').val()== '' || $('#endCnperiod').val()== '' || 
							$('#startShdate').val() == '' || $('#endShdate').val() == '' ||
							$('#leftinput1').val() == '') {
							  swal('다시 입력하세요!', "입력되지 않은 출하정보가 있습니다!", 'warning')
						} 
				
				$.ajax({
					url: 'shipList',
					method: 'POST',
					data : {startCp, endCp, startSd, endSd, gsCode},
					success: function(result) {
						grid.refreshLayout();
						grid.resetData(result)
					}
				})
			})
			
			/* 생산의뢰 삭제 버튼 */
			$('#deleteBtn').on('click', function() {
				delGrid = grid.getCheckedRows()
				var shList = delGrid.map((e) => {return e.shnum})
				$.ajax({
					url: 'delShList',
					method: 'POST',
					data : {shList},
					success: function() {
						grid.removeCheckedRows('')
						swal("삭제 성공!!", "선택한 출하 내역이 삭제되었습니다.", "success");
					}
				})
			})

				/*메이크 모달*/
				function makeModal(e, fnc) {
					var dialog = $(e).dialog({
						autoOpen : false,
						height : 742,
						width : 700,
						modal : true,
						buttons : {
							'확인' : fnc,
							'취소' : function() {
								$(this).dialog('close')
							}
						}
					});
					$('.ui-dialog-buttonset').children().attr('class', 'btn btn-secondary')
					$('.ui-dialog-titlebar-close').html('X').css('border', 'none')
					return dialog;
				}

				var modal1 = makeModal("#shippingModal", check)
				var modal2 = makeModal("#prodNameModal", giup)
					modal2 = makeModal("#prodNameModal", giup1)

				/*미출고모달*/
				$("#rightinput").on("click", function() {
					$("#shippingModal").css('display', '')
					modal1.dialog('open')
					barmo.refreshLayout();

				})
				/*확인버튼 눌렀을떄 */
				function check() {

				}
				
				
					/* 제품정보 모달 */
					$("#leftinput").on("click", function() {
						$("#prodNameModal").css('display', '')
						modal2.dialog('open')
						//전체제품 바로 띄우는 ajax 호출
						$.ajax({
							url:'allGoodsList',
							method: 'POST',
							success: function(result) {
								jepoom.refreshLayout();
								jepoom.resetData(result)
								jepoom.on('click', e => {
									var rok = e.rowKey
									gin = jepoom.getRow(rok).giname
									gic = jepoom.getRow(rok).gicode
								})
							}
						})
					})
					
			/* 제품정보 모달 검색 이벤트 */
			$('#gisearchBtn').on('click', function() {
				var giname = $('#giinput').val()
				$.ajax({
					url: 'goodsList',
					method: 'POST',
					data : {giname},
					success: function(result) {
						jepoom.resetData(result)
						jepoom.on('click', e => {
							var rok = e.rowKey
							gin1 = jepoom.getRow(rok).giname
							gic1 = jepoom.getRow(rok).gicode
						})
					}
				})
			})
				
		/*제품정보 검색조회 모달 확인버튼 눌렀을떄 */
		function giup() {
			$('#leftinput').val(gin1)
			$('#leftinput1').val(gic1)
			modal2.dialog('close')
		}

		/*제품정보 전체조회 모달 확인버튼 눌렀을떄 */
		function giup1() {
			$('#leftinput').val(gin)
			$('#leftinput1').val(gic)
			modal2.dialog('close')
		}

				
				
			/* 출고관리 메인 그리드 */
			const gridData = [];

			const grid = new tui.Grid({
				el : document.getElementById('grid'),
				data : gridData,
				scrollX : false,
				rowHeaders : [ 'rowNum', 'checkbox' ],
				columns : [{
					header : '출하번호',
					name : 'shnum',
					align : 'center'
				},{
					header : '수주번호',
					name : 'cnnum',
					align : 'center'
				}, {
					header : '거래처명',
					name : 'csname',
					align : 'center'
				}, {
					header : '제품명',
					name : 'giname',
					align : 'center'
				}, {
					header : '수주수량',
					name : 'cnam',
					align : 'center'
				}, {
					header : '총출하수량',
					align : 'center'
				}, {
					header : '금번출하수량',
					name : 'shdam',
					align : 'center'
				}, {
					header : '출고일자',
					name : 'shdate',
					align : 'center'
				}, {
					header : '납기일자',
					name : 'cnperiod',
					align : 'center'
				}, {
					header : '출하진행상태',
					name : 'shstatus',
					align : 'center'
				} ]
			});

				/*미출고 모달 그리드*/
				const totaldata = [];

				let barmo = new tui.Grid({
					el : document.getElementById('gridcomp'),
					data : totaldata,
					scrollX : false,
					rowHeaders : [ 'rowNum', 'checkbox' ],
					bodyHeight : 430,
					columns : [ {
						header : '수주번호',
						name : 'cnnum',
						align : 'center',
						sortingType : 'desc',
						sortable : true
					}, {
						header : '제품코드',
						name : 'gicode',
						align : 'center',
						sortingType : 'desc',
						sortable : true
					}, {
						header : '제품명',
						name : 'giname',
						align : 'center',
						sortingType : 'desc',
						sortable : true
					}, {
						header : '납기일자',
						name : 'cnperiod',
						align : 'center',
						sortingType : 'desc',
						sortable : true
					}, {
						header : '수주수량',
						name : 'cnam',
						align : 'center',
						sortingType : 'desc',
						sortable : true
					}, {
						header : '총출하수량',
						align : 'center',
						sortingType : 'desc',
						sortable : true
					}, {
						header : '미출하수량',
						align : 'center',
						sortingType : 'desc',
						sortable : true
					}, {
						header : '출하량',
						align : 'center',
						sortingType : 'desc',
						sortable : true
					} ]
				});

				/*제품정보 그리드*/
				const giupdata = [];

				let jepoom = new tui.Grid({
					el : document.getElementById('gridpro'),
					data : giupdata,
					scrollX : false,
					rowHeaders : [ 'rowNum', 'checkbox' ],
					bodyHeight : 430,
					columns : [ {
						header : '제품코드',
						name : 'gicode',
						align : 'center',
						sortingType : 'desc',
						sortable : true
					}, {
						header : '제품명',
						name : 'giname',
						align : 'center',
						sortingType : 'desc',
						sortable : true
					}, {
						header : '제품단위',
						name : 'giunit',
						align : 'center',
						sortingType : 'desc',
						sortable : true
					} ]
				});
			})
		</script>
	</th:block>
</body>
</html>