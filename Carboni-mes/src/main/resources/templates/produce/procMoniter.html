<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/layout}">
<head>
<style>
.tui-datepicker {
	z-index: 99;
}
h5 {
	font-weight: 700;
	margin-bottom: 15px;
}

ul.tabs {
	margin: 0px;
	padding: 0px;
	list-style: none;
}

ul.tabs li {
	display: inline-block;
	background: #898989;
	color: white;
	font-weight: 700;
	padding: 10px 15px;
	cursor: pointer;
}

ul.tabs li.current {
	background: #e0e0e0;
	color: black;
	font-weight: 700;
}

.tab-content {
	display: none;
	background: #e0e0e0;
	padding: 5px;
}

.tab-content.current {
	display: inherit;
}

.fw {
	font-weight: 700;
	margin-right: 10px;
}

.mg5 {
	margin-top: 5px;
}

#manageBtn {
	text-align: center;
	margin-top: 40px;
}

#start, #end {
	border: none;
	display: inline-block;
	width: 100px;
	height: 100px;
	background: #ddd;
	line-height: 100px;
	text-align: center;
	font-size: 2em;
}

.item.mone {
	grid-column: 1;
	grid-row: 1/4;
	margin-right: 10px;
}

.item.mtwo {
	grid-column: 2/5;
	grid-row: 1/2;
}

.item.mthree {
	grid-column: 2/5;
	grid-row: 2/4;
	margin-top: 0;
}

.proc {
	margin-bottom: 10px;
}

.ig {
	margin: 10px 0 10px 0;
	padding: 15px;
}

.box {
	padding: 15px;
	margin: 10px 10px 0 0;
}
/* 그리드용 css */

.tui-grid-cell.rowSelect {
	background-color: #ffffff;
}
</style>
</head>
<body class="sb-nav-fixed">
	<th:block layout:fragment="main">

		<div class="container-fluid px-4">
			<h1 class="mt-4" style="margin-bottom: 20px;">공정모니터링</h1>

			<!-- 탭 -->
			<ul class="tabs">
				<li class="tab-link current" data-tab="tab-1">공정진행관리</li>
				<li class="tab-link" data-tab="tab-2">공정모니터링</li>
			</ul>

			<!-- 내용 -->
			<!-- 공정진행관리 -->
			<div id="tab-1" class="tab-content current">
				<div style="background: white; padding-bottom: 5px;">
					<div class="card-header">
						<div style="display: flex; justify-content: flex-end;">
							<button type="button" id="orderBtn" class="btn btn-secondary"
								style="margin-right: 5px;">생산지시목록</button>
							<button type="button" id="resetBtn" class="btn btn-secondary"
								style="margin-right: 5px;">새자료</button>
						</div>
					</div>
					<div class="content container-fluid"
						style="display: flex; flex-flow: row wrap; justify-content: flex-start; align-items: stretch; padding-right: 0;">
						<div class="item border box" style="width:900px; overflow:auto;">
							<h5>진행생산지시</h5>
							<div id="orderGrid2"></div>
						</div>
						<div class="item border box" style="flex-grow: 1;">
							<h5>가동관리</h5>
							<div id="manageBtn">
								<input type="hidden" id="readyPcnum">									
								<button type="button" id="start">시작</button>
								<button type="button" id="end">종료</button>
							</div>
						</div>
					</div>
					<br>
					<div>
						<div class="border box" style="margin: 10px;">
							<h5>공정목록</h5>
							<div id="headGrid"></div>
						</div>
					</div>
				</div>
			</div>

			<!-- 공정모니터링 -->
			<div id="tab-2" class="tab-content">

				<div class="container-fluid"
					style="display: grid; background: white;">
					<div class="item ig mone border">
						<h5>공정진행상황</h5>
						<div class="border proc">공정1</div>
						<div class="border proc">공정2</div>
						<div class="border proc">공정3</div>
						<div class="border">공정4</div>
					</div>
					<div class="item ig mtwo border">
						<h5>온도</h5>
					</div>
					<div class="item ig mthree border">
						<h5>생산</h5>
						<div id="process"></div>
					</div>
				</div>
			</div>

		</div>

		<!-- 모달 -->
		<div id="modal">

			<!-- 생산지시목록 -->
			<div id="orderModal" style="padding: 20px;" title="생산지시조회">
				<!-- 작성일자 검색 -->
				<form class="container-fluid" id="searchForm" name="searchForm">
					<div class="search-area search-area-border" style="width: 100%;">
						<div style="margin-bottom: 10px;">
							<label class="fw">작업일자</label>
							<div
								class="tui-datepicker-input tui-datetime-input tui-has-focus mg5">
								<input type="text" class="form-control" id="workDt"
									aria-label="Date-Time"> <span class="tui-ico-date"></span>
								<div id="wrapper" style="margin-top: -1px;"></div>
							</div>
							<button type="button" class="ml-1 mw50 btn-sm btn-secondary btn-block"
								id="orSearchBtn" style="margin-left: 5px;">검색</button>
						</div>
					</div>
				</form>
				<!-- 그리드 -->
				<div id="orderGrid1"></div>
			</div>

		</div>



		<!-- 스크립트 -->
		<script type="text/javascript">
		
			$(function() {
				
//				탭--------------------------------------
				$('ul.tabs li').click(function() {
					var tab_id = $(this).attr('data-tab');

					$('ul.tabs li').removeClass('current');
					$('.tab-content').removeClass('current');

					$(this).addClass('current');
					$("#" + tab_id).addClass('current');
				})
				// 탭끝-------------------------------------
				
				// 공통 ajax 함수 -------------------------------
				function makeAjaxCall(url, data, async, callback, error) {
					$.ajax({
						url: url,
						method: 'POST',
						data: data,
						async: async,
						success: callback,
						error: error
					})
				}
				// --------------------------------------------
				
				
				// 그리드---------------------------------------------
				
				/* 공정진행관리 - 생산지시모달 */
				const orderList1 = [];
				
				const orderGrid1 = new tui.Grid({
					el : document.getElementById('orderGrid1'),
					data : orderList1,
					scrollX : true,
					columns : [ {
						header : '지시번호',
						name: 'pcnum',
						align : 'center'
					}, {
						header : '지시상세번호',
						name: 'pcdnum',
						align : 'center'
					}, {
						header : '지시명',
						name: 'pcname',
						align : 'center'
					}, {
						header : '제품명',
						name: 'giname',
						align : 'center'
					}, {
						header : '제품코드',
						name: 'gicode',
						align : 'center'
					}, {
						header : '지시량',
						name: 'pcdam',
						align : 'center'
					} ]
				});
				orderGrid1.hideColumn('pcdnum');
				orderGrid1.hideColumn('gicode');
				
				
				/* 공정진행관리 - 진행생산지시 */
				const orderList2 = [];
	
				const orderGrid2 = new tui.Grid({
					el : document.getElementById('orderGrid2'),
					data : orderList2,
					scrollX : false,
					columns : [ {
						header : '지시번호',
						name : 'pcnum',
						align : 'center'
					}, {
						header : '지시상세번호',
						name : 'pcdnum',
						align : 'center'
					}, {
						header : '제품명',
						name : 'giname',
						align : 'center'
					}, {
						header : '제품코드',
						name : 'gicode',
						align : 'center'
					}, {
						header : '목표수량',
						name : 'pcdam',
						align : 'center'
					}, {
						header : '라인번호',
						name : 'lineid',
						align : 'center'
					}, {
						header : '담당자',
						name : 'pcdkeeper',
						align : 'center'
					} ]
				});
				orderGrid2.hideColumn('pcdnum');
	
				/* 공정진행관리 - 공정목록 */
				const headList = [];
	
				const headGrid = new tui.Grid({
					el : document.getElementById('headGrid'),
					data : headList,
					scrollX : false,
					columns : [ {
						header : '지시번호',
						name : 'pcnum',
						align : 'center'
					}, {
						header : '지시상세번호',
						name : 'pcdnum',
						align : 'center'
					}, {
						header : '공정코드',
						name : 'picodeid',
						align : 'center'
					}, {
						header : '공정명',
						name : 'piname',
						align : 'center'
					}, {
						header : '설비번호',
						name : 'sinum',
						align : 'center'
					}, {
						header : '시작시간',
						name : 'phdstime',
						align : 'center'
					}, {
						header : '종료시간',
						name : 'phdetime',
						align : 'center'
					}, {
						header : '목표수량',
						name : 'pcdam',
						align : 'center'
					}, {
						header : '생산량',
						name : 'phdmkam',
						align : 'center'
					}, {
						header : '불량량',
						name : 'phderram',
						align : 'center'
					}, {
						header : '가동상태',
						name : 'phdstat',
						align : 'center'
					}, {
						header : '라인번호',
						name : 'lineid',
						align : 'center'
					}, {
						header : '작업번호',
						name : 'phnum',
						align : 'center'
					}, {
						header : '작업상세번호',
						name : 'phdnum',
						align : 'center'
					} ]
				});
				headGrid.hideColumn('pcdnum')
				headGrid.hideColumn('lineid')
				headGrid.hideColumn('phnum')
				headGrid.hideColumn('phdnum')
	
				/* 공정모니터링 - 생산 */
				const processList = [];
	
				const Grid3 = new tui.Grid({
					el : document.getElementById('process'),
					data : processList,
					scrollX : false,
					columns : [ {
						header : '지시번호',
						align : 'center'
					}, {
						header : '제품명',
						align : 'center'
					}, {
						header : '공정코드',
						align : 'center'
					}, {
						header : '1차공정',
						align : 'center'
					}, {
						header : '2차공정',
						align : 'center'
					}, {
						header : '3차공정',
						align : 'center'
					}, {
						header : '4차공정',
						align : 'center'
					}, {
						header : '설비코드',
						align : 'center'
					}, {
						header : '가동상태',
						align : 'center'
					}, {
						header : '목표수량',
						align : 'center'
					}, {
						header : '로스율',
						align : 'center'
					} ]
				});
				
	
				// 그리드끝------------------------------------------

				// 모달---------------------------------------------
				var modal1 = makeModal('#orderModal', orderView)
				
				/* 생산지시목록모달 작업일자로 검색 */
				$('#orderBtn').on('click', function(){
					modal1.dialog('open')
					orderGrid1.refreshLayout();
					$('#orSearchBtn').on('click', function(){
						var workDt = $('#workDt').val()
						makeAjaxCall('callOrder', {workDt}, true, function(result){
							orderGrid1.resetData(result);
							orderGrid1.on('click', e => {
								for(i=0; i<orderGrid1.getRowCount(); i++) {
									orderGrid1.removeRowClassName(i, 'rowSelect')
								}
								orderGrid1.addRowClassName(e.rowKey, 'rowSelect')
								findNum = orderGrid1.getValue(e.rowKey, 'pcnum')
							})
						})
					})
				})
				/* 진행생산지시로 추가 */
				function orderView(){
					makeAjaxCall('loadOrder', {findNum}, true, function(rs){
						datepicker1.setDate(new Date());
						orderGrid1.clear()
						orderGrid2.appendRows(rs)
					})
					modal1.dialog('close')
				}
				
				
				/* 모달틀 */
				function makeModal(e, fnc) {
					var dialog = $(e).dialog({
						autoOpen: false,
						height: 600,
						width: 700,
						modal: true,
						buttons: {
							"확인": fnc,
							"취소": function () {
								orderGrid1.resetData(orderList);
								datepicker1.setDate(new Date());
								$(this).dialog('close')
							}
						}
					});
					$('.ui-dialog-buttonset').children().attr('class', 'btn btn-secondary')
					$('.ui-dialog-titlebar-close').html('X').css('border', 'none').on('click', function(){
						orderGrid1.resetData(orderList);
						datepicker1.setDate(new Date());
					})
					return dialog;
				}
				// 모달 끝-------------------------------------------
				
				// 그리드 이벤트---------------------------------------
				/* 진행생산지시 */
				orderGrid2.on('dblclick', e => {
					for(i=0; i<orderGrid2.getRowCount(); i++) {
						orderGrid2.removeRowClassName(i, 'rowSelect')
					}
					orderGrid2.addRowClassName(e.rowKey, 'rowSelect')
					var pcnum = orderGrid2.getValue(e.rowKey, 'pcnum')
					var lineid = orderGrid2.getValue(e.rowKey, 'lineid')
					$('#readyPcnum').val(pcnum)
					makeAjaxCall('loadProdLine', {pcnum, lineid}, true, function(result) {
						headGrid.resetData(result)
						for(i=0; i<headGrid.getRowCount(); i++) {
							headGrid.setValue(i, 'phdstat', '정지')
						}
					})
				})
				
				
				// 그리드 이벤트 끝-------------------------------------
				
				// 버튼 이벤트-----------------------------------------
				
				/* 새자료 */
				$('#resetBtn').on('click', function () {
					fnFormClear();
				})
				function fnFormClear() {
					$('#readyPcnum').val('')
					headGrid.clear();
					for(i=0; i<orderGrid2.getRowCount(); i++) {
						orderGrid2.removeRowClassName(i, 'rowSelect')
					}
				}
				
				/* 해당 생산지시라인시작 */
				var arr = [];
				$('#start').on('click', function(){
					if($('#readyPcnum').val() != '') { // 시작버튼에 지시번호가 있을때
						Promise.all(['insert1', 'select1', 'insert2', 'select2', 'insert3', 'select3'])
									.then(function(){
										console.log('공정진행insert')
									})
							
						/* for(let i=0; i<headGrid.getRowCount(); i++) { // 그리드 행 수
							(function(i){
								var pcnum = headGrid.getValue(i, 'pcnum') // 지시번호
								var sinum = headGrid.getValue(i, 'sinum') // 설비번호
								var lineid = headGrid.getValue(i, 'lineid') // 라인이름
								var pcdam = headGrid.getData()[0].pcdam // 최초 지시량
								var phderram = Math.floor(pcdam*(Math.random()*0.01)) // 불량량
								headGrid.setValue(i, 'phdstat', '대기')
								function loadProdLine(){ // 2번째 ajax
									timer = setInterval(function(){
										if(headGrid.getValue(2, 'phdstat') == '완료') {
											for(y=0; y<arr.length; y++) {
												clearInterval(arr[y])
											}
											arr = [];
										} else {
											makeAjaxCall('loadTime', {pcnum, sinum}, false, function(result) {
												if(result.phdstime != null && result.phdetime == null) { // 시작시간만
													headGrid.setValue(i, 'phdstime', result.phdstime)
													headGrid.setValue(i, 'phdstat', '가동')
												} else if(result.phdstime != null) { // 종료시간 찍혔을때
													headGrid.setValue(i, 'phdstime', result.phdstime)
													headGrid.setValue(i, 'phdetime', result.phdetime)
													headGrid.setValue(i, 'phdstat', '완료')
													if(i==0) {
														headGrid.setValue(i, 'phdmkam', pcdam-phderram) // 생산량
														headGrid.setValue(i, 'phderram', phderram) // 불량량
													} else {
														var prevDam = headGrid.getValue(i-1, 'phdmkam') // 그전행 생산량
														var prevRram = Math.floor(prevDam*(Math.random()*0.01))
														headGrid.setValue(i, 'phdmkam', prevDam-prevRram)
														headGrid.setValue(i, 'phderram', prevRram)
														arr.push(timer)
													}
													insertProcHead();
												}
											})
										}
									} , 2000)
								}
								makeAjaxCall('insertSinum', {pcnum, sinum}, false, loadProdLine) // 1번째 ajax
							})(i)
						} */
					} else {
						swal('선택된 생산지시가 없습니다.', '', 'warning')
					}
				})
				
				
				
				// 버튼 이벤트 끝---------------------------------------
				
				
				// 달력---------------------------------------------
				
				/* 계획일자 */
				const datepicker1 = new tui.DatePicker('#wrapper', {
					date : new Date(),
					input : {
						element : '#workDt',
						format : 'yyyy-MM-dd'
					},
					language : 'ko'
		
				});
				// 달력 끝-------------------------------------------
				

			})
		</script>
	</th:block>

</body>
</html>