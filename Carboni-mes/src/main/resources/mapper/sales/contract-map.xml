<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="co.carboni.prj.sales.mapper.SalesMapper">
	
	<!-- 수주관리 -->
	
		<!-- 수주목록 삭제 -->
		<delete id="findDelCnList" parameterType="co.carboni.prj.sales.vo.SalesVO">
			DELETE FROM contract
			WHERE cnnum in
			<foreach collection="cnList" item="arr" open="(" separator="," close=")" >
				#{arr}
			</foreach>
		</delete>
		
		<!-- 수주관리 수주일자 조회 -->
		<select id="findCndateList" resultType="co.carboni.prj.sales.vo.SalesVO">
			SELECT m.cnnum, c.csname, g.giname, m.cnam, m.cnrest, m.cndate, m.cnperiod, m.cnstatus, g.giunit
			FROM contract m, costomer c, goodsinfo g
			WHERE (c.cscode = m.cscode AND g.gicode = m.gicode)
			AND
			(m.cndate BETWEEN #{startDt} AND #{endDt})
			AND
			m.cscode = #{cusCode}
			AND
			m.gicode =#{goodsCode}
		</select>
		
		<!-- 거래처모달 전체조회 -->
		<select id="findAllCsList" resultType="co.carboni.prj.sales.vo.SalesVO">
			SELECT cscode, csname, csnum, cstel FROM costomer
			WHERE csgb = '제품거래'
		</select>
	
		<!-- 거래처모달 검색조회 -->
		<select id="findCsList" resultType="co.carboni.prj.sales.vo.SalesVO">
			SELECT cscode, csname, csnum, cstel FROM costomer
			WHERE csname like '%' || #{csname} || '%'
			AND csgb = '제품거래'
		</select>
		
		<!-- 제품모달 전체조회 -->
		<select id="findAllGiList" resultType="co.carboni.prj.sales.vo.SalesVO">
			SELECT gicode, giname, giunit FROM goodsinfo
		</select>
		
		<!-- 제품모달 검색조회 -->
		<select id="findGiList" resultType="co.carboni.prj.sales.vo.SalesVO">
			SELECT gicode, giname, giunit FROM goodsinfo
			WHERE giname like '%' || #{giname} || '%'
		</select>
		
	<!-- 생산의뢰관리 -->
	
		
	
		<!-- 생산의뢰 등록 -->
		<insert id="prodReqInsert" parameterType="co.carboni.prj.sales.vo.SalesVO" useGeneratedKeys="true" keyColumn="prnum" keyProperty="prnum">
			INSERT INTO prodreq
			VALUES (('PR-'||TO_CHAR(prodreq_PRNUM_seq.nextval)), #{prclose}, 'N', #{cnnum})
			<selectKey resultType="string" keyProperty="prnum" order="AFTER">
				SELECT 'PR-'||max(TO_NUMBER(SUBSTR(prnum, 4))) AS prnum FROM prodreq
			</selectKey>
		</insert>
		
		<!-- 생산의뢰등록 -> 수정(수주관리에 진행상태 변경) -->
		<update id="updateCnStat" parameterType="co.carboni.prj.sales.vo.SalesVO">
			UPDATE contract
			SET cnstatus = '생산중'
			WHERE cnnum = (SELECT cnnum FROM prodreq WHERE prnum =#{prnum})
		</update>
	
		<!-- 생산의뢰 조회 -->
		<select id="findPrcloseList" resultType="co.carboni.prj.sales.vo.SalesVO">
			SELECT p.prnum, p.cnnum, g.giname, r.csname, c.cndate, c.cnperiod, p.prclose, p.prstatus
			FROM contract c, prodreq p, costomer r, goodsinfo g
			WHERE (c.cnnum = p.cnnum AND c.gicode = g.gicode AND c.cscode = r.cscode)
			AND
			(c.cndate BETWEEN #{startCd} AND #{endCd})
			AND
			(p.prclose BETWEEN #{startPr} AND #{endPr})
			AND
			p.prstatus = #{complete}
			AND
			c.gicode = #{gsCode}
		</select>
		
		<!-- 생산의뢰목록 삭제 -->
		<delete id="findDelPrList" parameterType="co.carboni.prj.sales.vo.SalesVO">
			DELETE FROM prodreq
			WHERE prnum in
			<foreach collection="prList" item="arr" open="(" separator="," close=")">
				#{arr}
			</foreach>
		</delete>
		
		<!-- 생산의뢰관리 수주일자 조회 -->
      	<select id="findPcndateList" resultType="co.carboni.prj.sales.vo.SalesVO">
	         SELECT c.cnnum, g.giname, m.csname, c.cndate, c.cnperiod
	         FROM contract c, goodsinfo g, costomer m
	         WHERE (c.gicode = g.gicode and c.cscode = m.cscode)
	         AND (c.cndate BETWEEN #{startDt} AND #{endDt}) 
	         AND c.cnstatus = '생산전' 
		</select>
		
	
	<!-- 출하관리 -->
	
		<!-- 출하등록 -->
		<insert id="shipInsert" parameterType="co.carboni.prj.sales.vo.SalesVO">
			INSERT INTO ship
			VALUES ( ('SH-'||to_char(ship_SHNUM_seq.nextval) ), #{cnnum}, #{sham}, #{shdate}, 'N' )
		</insert>
	
		<!-- 출하목록 삭제 -->
		<delete id="findDelShList" parameterType="co.carboni.prj.sales.vo.SalesVO">
			DELETE FROM ship
			WHERE shnum in
			<foreach collection="shList" item="arr" open="(" separator="," close=")">
				#{arr}
			</foreach>
		</delete>
		
		<!-- 출하관리 출하등록 수주일자 조회 -->
		<select id="findScndateList" resultType="co.carboni.prj.sales.vo.SalesVO">
			SELECT c.cnnum, g.giname, r.csname, c.cnperiod, c.cndate, c.cnstatus
			FROM contract c, costomer r, goodsinfo g
			WHERE (c.gicode = g.gicode AND c.cscode = r.cscode)
			AND
			(c.cndate BETWEEN #{startScd} AND #{endScd})
            AND
            c.cnstatus = '생산완료'
		</select>
		
		<!-- 출하목록 조회 -->
		<select id="findShipList" resultType="co.carboni.prj.sales.vo.SalesVO">
			SELECT s.shnum, c.cnnum, g.giname, r.csname, c.cnam, s.sham, s.shdate, c.cnperiod, s.shstatus
			FROM contract c, ship s, costomer r, goodsinfo g
			WHERE (c.cnnum = s.cnnum AND c.gicode = g.gicode AND c.cscode = r.cscode)
			AND
			(c.cnperiod BETWEEN #{startCp} AND #{endCp})
			AND
			(s.shdate BETWEEN #{startSd} AND #{endSd})
			AND
			c.gicode = #{gsCode}
		</select>
		
		<!-- 출하관리 미출고건 납기일자 조회 -->
		<select id="findNoProdList" resultType="co.carboni.prj.sales.vo.SalesVO">
			SELECT c.cnnum, g.giname, r.csname, c.cnperiod, c.cnam, c.cnrest
			FROM contract c, costomer r, goodsinfo g
			WHERE (c.gicode = g.gicode AND c.cscode = r.cscode)
			AND
			(c.cnperiod BETWEEN #{startCpd} AND #{endCpd})

		</select>
		
	<!-- 제품재고관리 -->
		
		<!-- 제품재고 조회 -->
		<select id="findStkList" resultType="co.carboni.prj.sales.vo.SalesVO">
			SELECT s.gsmnum, s.gsam, s.gicode, i.giname, i.giunit, i.gisafe
			FROM goodsinfo i, goodsstk s
			WHERE (i.gicode = s.gicode)
			AND
			s.gicode = #{gssCode}
		</select>
		
		<!-- 제품재고 삭제 -->
		<delete id="findDelGsmList" parameterType="co.carboni.prj.sales.vo.SalesVO">
			DELETE FROM goodsstk
			WHERE gsmnum in
			<foreach collection="gsmList" item="arr" open="(" separator="," close=")">
				#{arr}
			</foreach>
		</delete>
		
		<!-- 제품재고등록 검색조회 -->
		<select id="findStkProdList" resultType="co.carboni.prj.sales.vo.SalesVO">
			SELECT  giname, gicode
			FROM goodsinfo
			WHERE giname like '%' || #{addStk} || '%'
		</select>
		
		<!-- 제품재고등록 전체조회 -->
		<select id="findAllStkProdList" resultType="co.carboni.prj.sales.vo.SalesVO">
			SELECT  giname, gicode
			FROM goodsinfo
		</select>
		
		<!-- 제품재고 등록 -->
		 <insert id="goodsStkInsert" parameterType="co.carboni.prj.sales.vo.SalesVO" useGeneratedKeys="true" keyColumn="gsmnum" keyProperty="gsmnum">
			INSERT INTO goodsstk
			VALUES (#{jepoomcoin}, #{gsamin}, ('GSM-'||TO_CHAR(goodsstk_GSMNUM_seq.nextval)))
			
		</insert> 
		
		<!-- 제품재고등록 -> 수정(재고 수량 변경) -->
		<update id="updateStkStat" parameterType="co.carboni.prj.sales.vo.SalesVO">
			UPDATE goodsstk
			SET gsam = #{gsam}
			WHERE gsmnum = #{gsmnum}
		</update>
		
	<!-- 배송관리 -->
	
		<!-- 배송관리 > 제품검색 -->
		<select id="findJepoomList" resultType="co.carboni.prj.sales.vo.SalesVO">
			SELECT c.cnnum, s.shnum, r.csname, g.giname, s.cnnum
			FROM contract c, ship s, costomer r, goodsinfo g
			WHERE (c.gicode = g.gicode AND c.cscode = r.cscode AND c.cnnum = s.cnnum)
			AND
			s.cnnum = #{cnList}
		</select>
		
		
</mapper>