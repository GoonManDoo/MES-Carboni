<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="co.carboni.prj.produce.mapper.ProdMapper">
	
	<!-- 미생산주문조회 -->
	<select id="findUnprod" resultType="co.carboni.prj.produce.vo.ProdPlanVO">
		SELECT x.prnum, y.cndate, z.csname, x.prclose
		FROM prodreq x, contract y, costomer z
		WHERE x.cnnum = y.cnnum
		AND y.cscode = z.cscode
		AND x.prclose >= TO_DATE(#{startDt}, 'YYYY/MM/DD')
		AND TO_DATE(#{endDt}, 'YYYY/MM/DD') >= x.prclose
		AND x.prstatus = 'N'
	</select>
	
	<!-- 미생산주문에 들어있는 제품 목록 -->
	<select id="planProduct" resultType="co.carboni.prj.produce.vo.ProdPlanVO">
		SELECT z.gicode, z.giname, z.giunit, x.prnum, x.prclose, y.cnrest
		FROM prodreq x, contract y, goodsinfo z
		WHERE y.cnnum = x.cnnum
		AND y.gicode = z.gicode
		AND x.prnum IN
		<foreach collection="orderNum" item="arr" open="(" separator="," close=")">
			#{arr}
		</foreach>
	</select>
	
	<!-- 제품목록에 있는 제품 선택했을 때 필요 자재 정보 뜨기 -->
	<select id="matList" resultType="co.carboni.prj.produce.vo.ProdPlanVO">
		SELECT c.gicode, b.micode, m.miname, b.bam, c.cnrest, t.msciam
		FROM prodreq p, contract c, bom b, matinfo m, matstk t
		WHERE p.cnnum = c.cnnum
		AND c.gicode = b.gicode
		AND b.micode = m.micode
		AND m.micode = t.micode
		AND p.prnum = #{prn}
	</select>
	
	<!-- 자재발주요청 -->
	<insert id="requestMat">
		INSERT INTO matreq
		VALUES ('MR-'||TO_CHAR(matreq_REQNUM_seq.nextval), #{micode}, #{orderAmount}, 'N')
	</insert>
	
	<!-- 생산계획등록 -->
	<insert id="addProdPlan" parameterType="co.carboni.prj.produce.vo.ProdPlanVO" useGeneratedKeys="true" keyColumn="ppnum" keyProperty="ppnum">
		INSERT INTO prodplan
		VALUES (('PP-'||PRODPLAN_PPNUM_SEQ.nextval), #{ppdate}, #{ppname}, '미지시', #{ppnote})
		<selectKey resultType="string" keyProperty="ppnum" order="AFTER">
			select 'PP-'||max(TO_NUMBER(SUBSTR(ppnum, 4))) as ppnum from prodplan
		</selectKey>
	</insert>
	
	<!-- 생산계획상세등록 -->
	<insert id="addPPlanDetail" parameterType="co.carboni.prj.produce.vo.ProdPlanVO">
			INSERT INTO prodplan_d
			VALUES
			(#{ppdnum}, #{ppnum}, #{prnum}, #{gicode}, TO_NUMBER(#{ppdam}), TO_NUMBER(#{uplam}), TO_DATE(#{ppddate, jdbcType=DATE}, 'YYYY/MM/DD'))
	</insert>
	
</mapper>