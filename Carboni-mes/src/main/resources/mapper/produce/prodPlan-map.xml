<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="co.carboni.prj.produce.mapper.ProdPlanMapper">
	
	<!-- 미생산주문조회 -->
	<select id="findUnprod" resultType="co.carboni.prj.produce.vo.ProdPlanVO">
		SELECT x.prnum, y.cndate, z.csname, x.prclose
		FROM prodreq x, contract y, costomer z
		WHERE x.cnnum = y.cnnum
		AND y.cscode = z.cscode
		AND x.prclose >= TO_DATE(#{startDt}, 'YYYY/MM/DD')
		AND TO_DATE(#{endDt}, 'YYYY/MM/DD') >= x.prclose
		AND x.prstatus = 'N'
	</select>
	
	<!-- 미생산주문에 들어있는 제품 목록 -->
	<select id="planProduct" resultType="co.carboni.prj.produce.vo.ProdPlanVO">
		SELECT z.gicode, z.giname, z.giunit, x.prnum, x.prclose, y.cnrest
		FROM prodreq x, contract y, goodsinfo z
		WHERE y.cnnum = x.cnnum
		AND y.gicode = z.gicode
		AND x.prnum IN
		<foreach collection="orderNum" item="arr" open="(" separator="," close=")">
			#{arr}
		</foreach>
	</select>
	
	<!-- 제품목록에 있는 제품 선택했을 때 필요 자재 정보 뜨기 -->
	<select id="matList" resultType="co.carboni.prj.produce.vo.ProdPlanVO">
		SELECT c.gicode, b.micode, m.miname, b.bam, c.cnrest, t.msciam
		FROM prodreq p, contract c, bom b, matinfo m, matstk t
		WHERE p.cnnum = c.cnnum
		AND c.gicode = b.gicode
		AND b.micode = m.micode
		AND m.micode = t.micode
		AND p.prnum = #{prn}
	</select>
	
	<insert id="requestMat">
		INSERT INTO matreq
		VALUES ('MR-'||TO_CHAR(matreq_REQNUM_seq.nextval), #{micode}, #{orderAmount}, 'N')
	</insert>
	
</mapper>