<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="co.carboni.prj.produce.mapper.ProdMapper">
	
	<!-- 생산계획관리 -->
		<!-- 생산계획검색 -->
		<select id="searchPlan" resultType="co.carboni.prj.produce.vo.ProdPlanVO">
			SELECT ppdate, ppnum, ppname, ppnote
			FROM prodplan
			WHERE (ppdate BETWEEN #{pstartDt} AND #{pendDt})
			AND ppstatus =
			<if test="pstatus == '미지시'">'미지시'</if>
			<if test="pstatus == '지시진행'">'지시진행'</if>
			ORDER BY ppnum ASC
		</select>
		
		<!-- 생산계획로드 -->
		<select id="prodPlan" resultType="co.carboni.prj.produce.vo.ProdPlanVO">
			SELECT ppnum, ppdate, ppname, ppnote
			FROM prodplan
			WHERE ppnum = #{findNum}
		</select>
		
		<!-- 생산계획상세로드 -->
		<select id="prodPlanDetail" resultType="co.carboni.prj.produce.vo.ProdPlanVO">
			SELECT p.ppdnum, p.gicode, g.giname, (g.giunit||(select cexplain from common where ccodeid = '17')) as giunit, p.prnum, r.prclose, c.cnrest, p.ppdam, p.uplam, p.ppddate
			FROM prodplan_d p, goodsinfo g, prodreq r, contract c
			WHERE
			p.gicode = g.gicode
			AND
			p.prnum = r.prnum
			AND
			r.cnnum = c.cnnum
			AND
			p.ppdnum LIKE #{findDNum}||'%'
		</select>
		
		<!-- 미생산의뢰조회 -->
		<select id="findUnprod" resultType="co.carboni.prj.produce.vo.ProdPlanVO">
			SELECT x.prnum, y.cndate, z.csname, x.prclose
			FROM prodreq x, contract y, costomer z
			WHERE x.cnnum = y.cnnum
			AND y.cscode = z.cscode
			AND (x.prclose BETWEEN #{startDt} AND #{endDt})
			AND x.prstatus = 'N'
		</select>
		
		<!-- 미생산주문에 들어있는 제품 목록 -->
		<select id="planProduct" resultType="co.carboni.prj.produce.vo.ProdPlanVO">
			SELECT z.gicode, z.giname, (z.giunit||(select cexplain from common where ccodeid = '17')) as giunit, x.prnum, x.prclose, y.cnrest
			FROM prodreq x, contract y, goodsinfo z
			WHERE y.cnnum = x.cnnum
			AND y.gicode = z.gicode
			AND x.prnum IN
			<foreach collection="rqNum" item="arr" open="(" separator="," close=")">
				#{arr}
			</foreach>
		</select>
		
		<!-- 제품목록에 있는 제품 선택했을 때 필요 자재 정보 뜨기 -->
		<select id="matList" resultType="co.carboni.prj.produce.vo.ProdPlanVO">
			SELECT c.gicode, b.micode, m.miname, b.bam, c.cnrest, t.msciam
			FROM prodreq p, contract c, bom b, matinfo m, matstk t
			WHERE p.cnnum = c.cnnum
			AND c.gicode = b.gicode
			AND b.micode = m.micode
			AND m.micode = t.micode
			AND p.prnum = #{prn}
		</select>
		
		<!-- 자재발주요청 -->
		<insert id="requestMat">
			INSERT INTO matreq
			VALUES ('MR-'||TO_CHAR(matreq_REQNUM_seq.nextval), #{micode}, #{orderAmount}, '발주전')
		</insert>
		
		<!-- 생산계획등록 -->
		<insert id="addProdPlan" parameterType="co.carboni.prj.produce.vo.ProdPlanVO" useGeneratedKeys="true" keyColumn="ppnum" keyProperty="ppnum">
			INSERT INTO prodplan
			VALUES (('PP-'||PRODPLAN_PPNUM_SEQ.nextval), #{ppdate}, #{ppname}, '미지시', #{ppnote})
			<selectKey resultType="string" keyProperty="ppnum" order="AFTER">
				SELECT 'PP-'||max(TO_NUMBER(SUBSTR(ppnum, 4))) AS ppnum FROM prodplan
			</selectKey>
		</insert>
		
		
		<!-- 생산계획상세등록 -->
		<insert id="addPPlanDetail" parameterType="co.carboni.prj.produce.vo.ProdPlanVO">
			INSERT INTO prodplan_d
			VALUES
			(#{ppdnum}, #{ppnum}, #{prnum, jdbcType=VARCHAR}, #{gicode}, TO_NUMBER(#{ppdam}), TO_NUMBER(#{uplam}), #{ppddate})
		</insert>
		
		<!-- 생산계획등록시 생산의뢰관리 상태변경 -->
		<update id="updatePReqStat" parameterType="co.carboni.prj.produce.vo.ProdPlanVO">
			UPDATE prodreq
			SET PRSTATUS = 'Y'
			WHERE prnum = #{prnum}
		</update>
		
		<!-- 생산계획수정 -->
		<update id="updateProdPlan" parameterType="co.carboni.prj.produce.vo.ProdPlanVO">
			UPDATE prodplan
			SET ppname = #{ppname}, ppnote = #{ppnote}
			WHERE ppnum = #{ppnum}
		</update>
		
		<!-- 생산계획상세 삭제 -->
		<delete id="delupPPdetail" parameterType="co.carboni.prj.produce.vo.ProdPlanVO">
			DELETE FROM prodplan_d
			WHERE ppdnum like #{ppnum}||'%'
		</delete>
		
		<!-- 생산계획상세수정 -->
	<!-- 	<update id="upPPlanDetail" parameterType="co.carboni.prj.produce.vo.ProdPlanVO">
			UPDATE prodplan_d
			SET ppdam = TO_NUMBER(#{ppdam}), uplam = TO_NUMBER(#{uplam}), ppddate = #{ppddate}
			WHERE ppdnum = #{ppdnum}
		</update> -->
		
		<!-- 생산계획, 계획상세 삭제 + 생산의뢰 상태변경 -->
		<update id="removeProdPlan" parameterType="co.carboni.prj.produce.vo.ProdPlanVO" statementType="CALLABLE">
			<![CDATA[{call update_preqstatus(#{ppnum})}]]>
		</update>
		
	
	<!-- 생산지시관리 -->
	
		<!-- 미지시계획조회 -->
		<select id="unorderList" resultType="co.carboni.prj.produce.vo.ProdOrderVO">
			SELECT ppnum, ppdate, ppname, ppnote
			FROM prodplan
			WHERE (ppdate BETWEEN #{startDt} AND #{endDt})
			AND
			ppstatus = '미지시'
		</select>
		
		<!-- 생산지시에 추가할 계획목록 -->
		<select id="addPlan" resultType="co.carboni.prj.produce.vo.ProdOrderVO">
			SELECT p.ppnum, p.ppname, g.giname, r.prclose, (d.ppdam+d.uplam) as ppadam, d.ppddate as pcdsdate, d.ppdnum, g.gicode, l.lineid
			FROM prodplan p, prodplan_d d, goodsinfo g, prodreq r, lineinfo l
			WHERE (p.ppnum = d.ppnum
			AND
			d.gicode = g.gicode
			AND
			g.gicode = l.gicode
			AND
			d.prnum = r.prnum)
			AND
			rownum = 1
			AND
			p.ppnum IN
			<foreach collection="planNums" item="arr" open="(" separator="," close=")">
				#{arr}
			</foreach>
		</select>
		
		<!-- 계획목록 제품 클릭시 제품, 자재정보 조회 -->
		<select id="goodsInfo" resultType="co.carboni.prj.produce.vo.ProdOrderVO">
			SELECT g.giname, m.micode, m.miname, b.bam, k.msciam
			FROM goodsinfo g, bom b, matinfo m, matstk k
			WHERE (g.gicode = b.gicode AND b.micode = m.micode AND m.micode = k.micode)
			AND g.gicode = #{gic}
		</select>
		
		<!-- 생산계획에 등록한 라인번호에 해당하는 공정정보 -->
		<select id="procInfo" resultType="co.carboni.prj.produce.vo.ProdOrderVO">
			SELECT * FROM procinfo
			WHERE picodeid in (SELECT picodeid FROM lineinfo WHERE gicode = #{gic})
		</select>
		
		<!-- 생산현장 담당자 등록을 위한 사원조회 -->
		<select id="empList" resultType="co.carboni.prj.produce.vo.ProdOrderVO">
			SELECT ecode, ename, eposition
			FROM employee
			WHERE eposition = #{posit}
		</select>
		
		<!-- 생산지시등록 -->
		<insert id="addProdOrder" parameterType="co.carboni.prj.produce.vo.ProdOrderVO" useGeneratedKeys="true" keyColumn="pcnum" keyProperty="pcnum">
			INSERT INTO prodcomm
			VALUES (('PC-'||PRODCOMM_PCNUM_SEQ.nextval), #{pcdate}, #{pcname}, '미공정', #{pcnote}, #{pcdkeeper})
			<selectKey resultType="string" keyProperty="pcnum" order="AFTER">
				SELECT 'PC-'||max(TO_NUMBER(SUBSTR(pcnum, 4))) AS pcnum FROM prodcomm
			</selectKey>
		</insert>
		
		<!-- 생산지시상세등록 -->
		<update id="addPOrderDetail" parameterType="co.carboni.prj.produce.vo.ProdOrderVO" statementType="CALLABLE">
			<![CDATA[{call add_proccomm_d(#{pcnum}, #{pcdnum}, #{lineid}, #{ppdnum}, #{gicode}, #{pcdam}, #{pcdsdate})}]]>
		</update>
		
		
		<!-- 재생산이 필요한 제품불량내역 -->
		<select id="reprodList" resultType="co.carboni.prj.produce.vo.ProdOrderVO">
			SELECT e.genum, e.gedate, p.phnum, e.gicode, g.giname, c.cexplaind, e.gedetail, e.gegdam
			FROM goods_err e, prochead_d p, common c, goodsinfo g
			WHERE (e.phdnum = p.phdnum and e.ccodeid = c.ccodeid and e.gicode = g.gicode)
			AND e.gestatus = 'N'
		</select>
	
		<!-- 생산지시수정 -->
		<select id="updateOrder" parameterType="co.carboni.prj.produce.vo.ProdOrderVO">
			update into prodcomm
			set pcname = #{pcname}, pcnote = #{pcnote}, pcdkeeper = #{pcdkeeper}
			where pcnum = #{pcnum}
		</select>
		
		<!-- 생산지시상세수정 -->
		
		<!-- 생산지시삭제 -->
		
		<!-- 생산지시조회 -->
	
	
</mapper>