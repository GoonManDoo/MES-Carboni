<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="co.carboni.prj.mat.mapper.MatMapper">
	<!-- 생산에서 발주요청한 사항 조회 -->
	<select id="findreq" resultType="co.carboni.prj.mat.vo.MatVO">
		SELECT
		E.REQNUM,E.MICODE,D.MINAME,E.MRREQAM,E.MRSTATUS
		FROM MATREQ E
		JOIN
		MATINFO D
		ON E.MICODE=D.MICODE
		WHERE E.MRSTATUS ='발주전'
	</select>
	<!-- 발주 메인에서 기업 검색 모달안의 내용 전체조회 -->
	<!-- 입고에서 기업 검색 모달안의 내용 조회 -->
	<select id="findComList"
		resultType="co.carboni.prj.mat.vo.MatVO">
		SELECT CSCODE, CSNAME, CSNUM,CSTEL
		FROM COSTOMER
		WHERE
		CSGB='자재거래'
	</select>

	<!-- 발주 메인에서 자재 검색 모달의 내용 조회 -->
	<select id="findMat" resultType="co.carboni.prj.mat.vo.MatVO">
		SELECT
		MICODE,MINAME,MISTAND,MIUNIT
		FROM MATINFO
	</select>

	<!-- 발주의 거래처명검색모달에서 거래처 검색 -->
	<!-- 입고의 거래처명검색모달에서 거래처 검색 -->
	<select id="findSearchComList"
		resultType="co.carboni.prj.mat.vo.MatVO">
		SELECT CSCODE, CSNAME, CSNUM, CSTEL
		FROM COSTOMER
		WHERE
		CSNAME LIKE '%' || #{csname} || '%'
		AND CSGB='자재거래'
	</select>

	<!-- 발주 메인에서 자재검색모달 안의 내용을 검색하여 조회 -->
	<select id="findSearchMat"
		resultType="co.carboni.prj.mat.vo.MatVO">
		SELECT MICODE,MINAME,MISTAND,MIUNIT
		FROM MATINFO
		WHERE MINAME
		LIKE '%' || #{miname} || '%'
	</select>

	<!--발주관리의 발주일자 조회해서 메인 그리드에 표시 (조회용) DB에서 찾아올떄 -->
	<select id="findReqDate"
		resultType="co.carboni.prj.mat.vo.MatVO">
		 select o.MOSTATUS,o.MONUM,o.REQNUM,o.MOODATE,o.MICODE,o.CSCODE,c.csname,m.miname,o.moaskam
        from matord o,costomer c,matinfo m
        where o.MOODATE >= TO_DATE(#{startD},'yyyy/MM/dd')
		AND TO_DATE(#{endD},'yyyy/MM/dd') >= o.MOODATE
        and c.cscode=o.cscode
        and o.micode=m.micode
        and o.cscode=#{cusCode}
        and o.micode=#{matCode}
	</select>

	<!-- 발주관리에서 자체발주할떄 자재코드,거래처명 검색해서 그리드에 출력 -->
	<select id="findCode" resultType="co.carboni.prj.mat.vo.MatVO">
		SELECT MICODE,MINAME,
		(SELECT
		CSNAME FROM COSTOMER WHERE CSCODE = #{cusCode}) AS CSNAME
		,#{cusCode}
		AS CSCODE
		FROM MATINFO
		WHERE MICODE= #{matCode}
	</select>

	<!-- 입고 관리에서 발주일자로 발주 내용 검색 -->
	<select id="inModalSearch"
		resultType="co.carboni.prj.mat.vo.MatVO">
		SELECT
		E.MONUM,E.MOODATE,E.MICODE,E.CSCODE,D.MINAME,D.MISTAND,D.MIUNIT,Z.CSNAME
		FROM MATORD E , MATINFO D ,COSTOMER Z
		WHERE E.MICODE=D.MICODE
		AND
		E.CSCODE=Z.CSCODE
		AND E.MOODATE >= TO_DATE(#{startD},'YYYY/MM/DD')
		AND
		TO_DATE(#{endD},'YYYY/MM/DD') >= E.MOODATE
		AND E.MOSTATUS='N'
	</select>

	<insert id="addRequestList" parameterType="co.carboni.prj.mat.vo.MatVO" useGeneratedKeys="true" keyColumn="monum" keyProperty="monum">
		<!-- <foreach collection="list" item="item"  open="BEGIN" separator="; " close="; END;"> -->
			INSERT INTO MATORD VALUES
			(('MO-'||matord_MONUM_seq.nextval), 
			#{micode},
			#{cscode},
			#{reqnum , jdbcType=VARCHAR}, 
			SYSDATE ,
			#{mrreqam , jdbcType=VARCHAR}, 
			#{moaskam}, 
			'N',
			#{monote , jdbcType=VARCHAR})
		<!-- </foreach> -->
		<selectKey resultType="string" keyProperty="monum" order="AFTER">
			select 'MO-'||max(TO_NUMBER(SUBSTR(monum,4))) as monum from matord
		</selectKey>
	</insert>

	<select id="selectReqList" resultType="co.carboni.prj.mat.vo.MatVO">
		SELECT O.MOODATE,O.MONUM,O.MOASKAM,O.MOSTATUS,O.MONOTE,
		C.CSNAME,M.MINAME,o.reqnum ,o.mrreqam,o.cscode
		FROM MATORD O ,COSTOMER C, MATINFO M
		WHERE (O.MICODE = M.MICODE
		AND C.CSCODE=O.CSCODE )
		
		AND O.MONUM= #{monum}
	</select>
	
	<!-- 생산에서 요청한 내용이 발주 완료 되었을때 상태 변경 -->
	<update id="updateReqStat" parameterType="co.carboni.prj.mat.vo.MatVO">
		update matreq
		<set>
		mrstatus = '발주완료'
		</set>
		where reqnum =#{reqnum}
	
	</update>
	
	<!-- 발주에서 발주내용 삭제할떄 -->
	<delete id="findDelreq" parameterType="co.carboni.prj.mat.vo.MatVO">
		delete from matord
		where monum in
		<foreach collection="dellist" item="arr" open="(" separator="," close=")" >
		#{arr}
		</foreach>
	</delete>
	

	

</mapper>